<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Importar arquivo</title>
</head>
<body>

<div th:include="fragments/header :: header"></div>

<div class="container-fluid">

    <div class="page-header">
        <h1>Importar exercícios</h1>
    </div>

    <form class="form-horizontal" enctype="multipart/form-data" action="/uploadFile" method="post">
        <fieldset>

            <!-- Form Name -->
            <legend>Selecione o arquivo</legend>

            <!-- File Button -->
            <div class="form-group">
                <label class="col-md-4 control-label" for="uploadFile">Importar arquivo</label>
                <div class="col-md-4">
                    <input id="uploadFile" name="uploadFile" class="input-file" type="file" />
                </div>
            </div>

            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />

            <!-- Button -->
            <div class="form-group">
                <label class="col-md-4 control-label" for="import"></label>
                <div class="col-md-4">
                    <button id="import" name="import" class="btn btn-primary">Importar</button>
                </div>
            </div>

        </fieldset>
    </form>


    <div id="content">

        <div th:id="all-exercises-imported">
            <h2>Todos os exercícios foram importados com sucesso!</h2>
        </div>

        <div th:id="no-exercises-found" th:if="${exercises != null and exercises.size() == 0}">
            <h2>Nenhum exercício foi extraído.</h2>
        </div>

        <div th:id="extracted-exercises" th:if="${exercises != null and exercises.size() > 0}">
            <h2>Exercícios extraídos</h2>

            <input type="hidden" th:id="exercise-length" th:value="${exercises.size()}" />
            <form class="form-horizontal exercise-form" enctype="multipart/form-data" action="/exercise" method="post" th:each="exercise : ${exercises}">
                <fieldset>
                    <div class="form-group">
                        <input th:name="exercise-label" th:value="${exercise.label}" class="form-control" />
                        <div th:each="option : ${exercise.exerciseOptions}">
                            <input th:name="option-label" th:value="${option.label}" class="form-control"  />
                        </div>
                        <br />
                        <div class="form-group">
                            <div class="col-md-offset-1  col-md-8">
                                <button class="btn btn-primary save-exercise">OK</button>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">


    $(document).ready(function(){

        var exerciseLength = parseInt($("#exercise-length").val());

        hideThings();

        $(".save-exercise").click(function(e) {
            e.preventDefault();
            var clickedForm = $(this).parent();
            while(true) {
                var itemTagName = clickedForm[0].tagName;
                if(itemTagName == 'FORM') break;
                if(itemTagName == 'BODY') { clickedForm = null; break; }
                clickedForm = clickedForm.parent()
            }
            var uri = clickedForm.attr("action");
            var formData = clickedForm.serializeArray();

            postFormData(clickedForm, uri, formData);

        });

        function postFormData(clickedForm, uri, formData) {
            $.post(uri, formData, function(data, textStatus, jqXHR) {})
            .done(function() {
                alert("Exercício importado com sucesso!");
                clickedForm.slideUp("1000");
                updateExercisesLeftAmmount();
            })

            .fail(function() {
                alert("Erro ao importar o exercício selecionado!");
            })
        }

        function updateExercisesLeftAmmount() {
            exerciseLength = exerciseLength - 1;
            if(exerciseLength == 0) {
                $("#all-exercises-imported").show();
                $("#extracted-exercises").hide();
            }
        }

        function hideThings() {
            $("#all-exercises-imported").hide();
        }

    });
</script>

</body>
</html>